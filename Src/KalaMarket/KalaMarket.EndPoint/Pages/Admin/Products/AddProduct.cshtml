@page
@model KalaMarket.EndPoint.Pages.Admin.Products.AddProductModel
@{
}
<section class="basic-elements">
    <div class="row">
        <div class="col-sm-12">
            <h2 class="content-header">فرم ثبت محصول جدید</h2>
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <div class="card-title-wrap bar-success">
                        <h4 class="card-title mb-0">اطلاعات محصول جدید را وارد نمایید</h4>
                    </div>
                </div>
                <div class="card-body">
                    <div class="px-3">
                        <form method="POST" id="AddProductForm" enctype=multipart/form-data>
                            <div class="form">
                                <div class="form-body">
                                    <div id="Show_Errors"></div>
                                    <div class="row">
                                        <amb-admin-divForm>
                                            <label asp-for="Name">نام محصول </label>
                                            <input asp-for="Name" class="form-control">
                                            <span class="text-danger" asp-validation-for="Name"></span>
                                        </amb-admin-divForm>
                                       
                                        @*       <div class="col-xl-4 col-lg-6 col-md-12 mb-1">
                                        <fieldset class="form-group">
                                        <label asp-for="BrandId"> برند </label>
                                        <select asp-for="BrandId">
                                        <option selected value="1">Enter</option>
                                        </select>
                                        <span class="text-danger" asp-validation-for="BrandId"></span>
                                        </fieldset>
                                        </div>*@
                                        <amb-admin-divForm>
                                            <label asp-for="Price"> قیمت</label>
                                            <input asp-for="Price" class="form-control">
                                            <span class="text-danger" asp-validation-for="Price"></span>
                                        </amb-admin-divForm>
                                        <amb-admin-divForm>
                                            <label asp-for="Inventory"> تعداد موجودی</label>
                                            <input asp-for="Inventory" class="form-control">
                                            <span class="text-danger" asp-validation-for="Inventory"></span>
                                        </amb-admin-divForm>
                                    
                                        <amb-admin-divForm>
                                            <label asp-for="Images">تصاویر </label>
                                            <input asp-for="Images" multiple class="form-control">
                                            <span class="text-danger" asp-validation-for="Images"></span>
                                        </amb-admin-divForm>
                                        <amb-admin-divForm>
                                            <label asp-for="CategoryId">دسته بندی </label>
                                            <select class="form-control" asp-for="CategoryId" asp-items="@Model.Categories"></select>
                                            <span class="text-danger" asp-validation-for="CategoryId"></span>
                                        </amb-admin-divForm>

                                        <div class="col-xl-12 col-lg-12 col-md-12 mb-1">
                                            <fieldset class="form-group">
                                                <label asp-for="Description"> توضیحات</label>
                                                <textarea asp-for="Description" class="form-control " rows="5"></textarea>
                                                <span class="text-danger" asp-validation-for="Description"></span>
                                            </fieldset>
                                        </div>
                                        <hr/>
                                        <hr/>
                                        <div class="col-xl-4 col-lg-6 col-md-12 mb-1">
                                            <fieldset class="form-group">
                                                <input id="Feature_Key" class="form-control" placeholder="نام ویژگی"/> 
                                            </fieldset>
                                        </div>
                                       
                                        <div class="col-xl-4 col-lg-6 col-md-12 mb-1">
                                            <fieldset class="form-group">
                                          
                                                <input id="Feature_Value" class="form-control" placeholder="مقدار ویژگی"/>
                                            </fieldset>
                                        </div>
                                        <div class="col-xl-4 col-lg-10 col-md-12 mb-1">
                                            <fieldset class="form-group">
                                                <a class="btn btn-success" id="btnAddFeatures">اضافه کردن ویژگی</a>
                                            </fieldset>
                                        </div>
                                       
                                        <amb-admin-divForm>
                                            <label asp-for="Displayed" class="h5 mx-3 ">نمایش داده شود؟ </label>
                                            <input asp-for="Displayed" class="form-check-input" type="checkbox">
                                            <span class="text-danger" asp-validation-for="Displayed"></span>
                                        </amb-admin-divForm>
                                        <table id="tbl_Features" class="col-md-12 table table-bordered table-hover table-striped table-condensed table-responsive">
                                            <thead>
                                            <tr>
                                                <th>
                                                    نام
                                                </th>
                                                <th>
                                                    مقدار
                                                </th>
                                                <th>

                                                </th>
                                            </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                        <div class="position-absolute" id="List_Feature">
                                        </div>
                                        <br/>
                                        <div class="col-xl-12 col-lg-12 col-md-12 mb-1 text-center">
                                            <fieldset class="form-group ">
                                                <button type="submit" id="btnAddProduct" class="col-xl-4 col-lg-4 col-md-4 mb-1 text-center btn btn-info"> افزودن محصول </button>
                                            </fieldset>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>




@section Script
    {
    <partial name="Shared/_ValidationScriptsPartial" />
    <script>
        jQuery.validator.addMethod("ValidFileExtension",
            function (value, element, param) {
                var extension = value.slice(((value.lastIndexOf(".") - 1) + 2));
                const validExtension = ["png", "jpeg", "jpg", "webp"];
                var result = validExtension.some((ex) => ex === extension);
                return result;
            });
        jQuery.validator.unobtrusive.adapters.addBool("ValidFileExtension");
    </script>
    <script>
        var isInputFeatureAdded = false;
        var AddProductForm = document.querySelector("#AddProductForm");
        var btnSubmitProductForm = document.querySelector("#btnAddProduct");
        var countTagForProduct = 0;
        AddProductForm.addEventListener("submit",
            (e) => {
                console.log("inputValue");
                console.log(isInputFeatureAdded);
                if (isInputFeatureAdded === true) {
                    isInputFeatureAdded = false;
                    $("#btnAddProduct").prop("disabled", true);
                } else {
                    e.preventDefault();
                    addInputFeatures();
                    $("#btnAddProduct").click();
                }
            });
        $("#btnAddFeatures").on("click",
            function () {

                var txtDisplayName = $("#Feature_Key").val();
                var txtValue = $("#Feature_Value").val();

                if (txtDisplayName == "" || txtValue == "") {
                    swal.fire(
                        'هشدار!',
                        "نام و مقدار را باید وارد کنید",
                        'warning'
                    );
                } else {
                    if (CheckProductFeatureExist(txtDisplayName) === true) {
                        swal.fire(
                            '!خطا',
                            "ویژگی تکراریست",
                            'error'
                        );
                    } else {
                        isInputFeatureAdded = false;
                        $('#tbl_Features tbody').append('<tr> <td>' + txtDisplayName + '</td>  <td>' + txtValue + '</td> <td> <a class="idFeatures btnDelete btn btn-danger"> حذف </a> </td> </tr>');
                        $("#txtDisplayName").val('');
                        $("#txtValue").val('');
                    }
                }
            });

        function CheckProductFeatureExist(feature) {
            var dataFeaturesViewModel = $('#tbl_Features tr:gt(0)').map(function () {
                return {
                    DisplayName: $(this.cells[0]).text(),
                };
            }).get();
            var result = false;
            $.each(dataFeaturesViewModel,
                function (i, val) {
                    console.log(val.DisplayName);
                    if (val.DisplayName === feature) {
                        result = true;
                    }
                });
            return result;
        }

        $("#tbl_Features").on('click',
            '.idFeatures',
            function () {
                $(this).closest('tr').remove();
            });


        function addInputFeatures() {
            var List_Feature = $("#List_Feature");
            List_Feature.empty();
            var ShowError = $("#Show_Errors");
            ShowError.empty();
            var dataFeaturesViewModel = $('#tbl_Features tr:gt(0)').map(function () {
                return {
                    DisplayName: $(this.cells[0]).text(),
                    Value: $(this.cells[1]).text(),
                };
            }).get();
            if (dataFeaturesViewModel.length === 0) {
                swal.fire(
                    'هشدار!',
                    "باید یک ویژگی وارد کنید",
                    'warning'
                );
            }
            $.each(dataFeaturesViewModel,
                function (i, val) {
                    List_Feature.append(`<input name="Features[${i}].KeyName" id="Features_${i}__KeyName" type="hidden" data-val="true" value="${val.DisplayName}"/></br>`);
                    List_Feature.append(`<input name="Features[${i}].KeyValue" id="Features_${i}__KeyValue" type="hidden"  value="${val.Value}"/></br>`);
                    ShowError.append(`<span class="text-danger" asp-validation-for="Features[${i}].KeyName"></span>`);
                    ShowError.append(`<span class="text-danger" asp-validation-for="Features[${i}].KeyValue"></span>`);
                    isInputFeatureAdded = true;
                });
            var formProduct = $('#AddProductForm');
            //sets up the validate
            formProduct.validate();
            //checks if it's valid
            if (formProduct.valid()) {
                //horray it's valid
                formProduct.prop("disabled", true);
                formProduct.submit();
            }

        }
    </script>
}
